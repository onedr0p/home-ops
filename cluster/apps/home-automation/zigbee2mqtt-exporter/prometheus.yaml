---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: &app zigbee2mqtt-exporter
  namespace: default
  labels: &labels
    app.kubernetes.io/instance: *app
    app.kubernetes.io/name: *app
spec:
  selector:
    matchLabels:
      <<: *labels
  endpoints:
    - port: http
      scheme: http
      path: /metrics
      interval: 1m
      scrapeTimeout: 10s
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: zigbee2mqtt-exporter
  namespace: default
spec:
  groups:
    - name: zigbee2mqtt-exporter.rules
      rules:
        - alert: Zigbee2MqttExporterAbsent
          annotations:
            summary: Zigbee2Mqtt Exporter has disappeared from Prometheus target discovery.
          expr: absent(up{job=~".*mqtt-exporter.*"} == 1)
          for: 15m
          labels:
            severity: critical
        - alert: Zigbee2MqttUnavailable
          annotations:
            summary: The zigbee device connection is lost,
              connection on topic {{$labels.topic}} is down.
          expr: zigbee2mqtt_zigbee_availability == 0
          for: 60m
          labels:
            severity: critical
        - alert: Zigbee2MqttBatteryLow
          annotations:
            summary: The zigbee device battery level is low,
              battery level on topic {{$labels.topic}} is at {{$value}}%.
          expr: zigbee2mqtt_battery < 10
          for: 60m
          labels:
            severity: warning
