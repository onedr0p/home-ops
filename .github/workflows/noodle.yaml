---
name: "Noodle"

on:
  pull_request:
    branches: ["main"]
    paths: ["kubernetes/**/helmrelease.yaml"]

env:
  # Currently no way to detect automatically
  DEFAULT_BRANCH: main
  BOT_USERNAME: rosey-bot[bot]
  HELMREPOSITORY_DIR: ./kubernetes/flux/repositories/helm

jobs:
  changed-files:
    name: Detect File Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3.2.0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@ce4b8e3cba2220de8132ac9721ff754efd6bb7d7 # v34.6.2
        with:
          json: true
          files: |
            kubernetes/**/helmrelease.yaml
      - id: set-matrix
        run: echo "matrix={\"file\":${{ steps.changed-files.outputs.all_changed_files }}}" >> "${GITHUB_OUTPUT}"

  noodle:
    name: Run Noodle
    runs-on: ubuntu-latest
    needs: [changed-files]
    strategy:
      matrix: ${{ fromJSON(needs.changed-files.outputs.matrix) }}
    steps:
      - name: Setup Kube Tools
        uses: yokawasa/action-setup-kube-tools@b91bb02bc122bd84ac7bbea5f25ed6b0f2ec6275 # renovate: tag=v0.9.2
        with:
          setup-tools: |
            helm
            kustomize
            yq
      - name: Setup Dyff
        run: |
          sudo snap install dyff
      - name: Checkout
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3.2.0
      - name: Run Noodle On PR Branch
        id: pr
        run: |
          releaseName=$(yq eval '.metadata.name' "${{ matrix.file }}")
          manifests=$(npx zx ./.github/scripts/noodle.mjs \
            --helm-release-name "${releaseName}" \
            --kustomize-base-dir "$(dirname "${{ matrix.file }}")" \
            --helm-repository-dir ${{ env.HELMREPOSITORY_DIR }})
          echo "file=${manifests}" >> "${GITHUB_OUTPUT}"
      - name: Checkout default branch
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3.2.0
        with:
          ref: "${{ env.DEFAULT_BRANCH }}"
          path: default
      - name: Run Noodle On Default Branch
        id: default
        working-directory: default
        run: |
          releaseName=$(yq eval '.metadata.name' "${{ matrix.file }}")
          manifests=$(npx zx ../.github/scripts/noodle.mjs \
            --helm-release-name "${releaseName}" \
            --kustomize-base-dir "$(dirname "${{ matrix.file }}")" \
            --helm-repository-dir ${{ env.HELMREPOSITORY_DIR }})
          echo "file=${manifests}" >> "${GITHUB_OUTPUT}"
      - name: Dyff
        id: dyff
        run: |
          cat ${{ steps.default.outputs.file }}
          echo "================"
          cat ${{ steps.pr.outputs.file }}
          dyff between --color off --truecolor off --omit-header \
            ${{ steps.default.outputs.file }} \
            ${{ steps.pr.outputs.file }}
