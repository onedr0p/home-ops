---
name: Scan Containers

on:
  pull_request:
    branches: ["main"]
    paths: ["kubernetes/**/*.yaml"]

jobs:
  changed-files:
    name: Detect File Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3.2.0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@ce4b8e3cba2220de8132ac9721ff754efd6bb7d7 # v34.6.2
        with:
          json: true
          files: |
            kubernetes/**/*.yaml
      - id: set-matrix
        run: echo "matrix={\"file\":${{ steps.changed-files.outputs.all_changed_files }}}" >> "$GITHUB_OUTPUT"

  extract-containers:
    name: Extract Containers
    runs-on: ubuntu-latest
    needs: [changed-files]
    strategy:
      matrix: ${{ fromJSON(needs.changed-files.outputs.matrix) }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3.2.0
      - name: Install Tools
        run: sudo apt-get install jo
      - name: Detect Containers in Files
        id: set-matrix
        run: |
          containers=$(bash ./.github/scripts/container-parser.sh --file "${{ matrix.file }}")
          echo "${containers}"
          echo "matrix=${containers}" >> "${GITHUB_OUTPUT}"

  scan-containers:
    name: Scan Containers
    runs-on: ubuntu-latest
    needs: [extract-containers]
    strategy:
      matrix: ${{ fromJSON(needs.extract-containers.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b # v3.2.0
      - name: Scan Container
        uses: aquasecurity/trivy-action@9ab158e8597f3b310480b9a69402b419bc03dbd5 # 0.8.0
        with:
          image-ref: ${{ matrix.containers }}
          vuln-type: os,library
          severity: CRITICAL
          format: sarif
          output: trivy-results.sarif
      - name: Upload scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@959cbb7472c4d4ad70cdfe6f4976053fe48ab394 # v2
        with:
          sarif_file: trivy-results.sarif
